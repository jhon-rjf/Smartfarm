# 🤖 YAML 기반 프롬프트 관리 시스템 가이드

## 📋 개요

MyApp 스마트 온실 시스템의 프롬프트 엔지니어링을 **YAML 파일**로 중앙 관리하는 시스템입니다. 이제 모든 AI 프롬프트를 코드 수정 없이 `prompts.yaml` 파일에서 쉽게 관리할 수 있습니다.

## 🏗️ 시스템 아키텍처

```
backend/
├── prompts.yaml          # 🎯 프롬프트 설정 중앙 관리
├── prompt_manager.py     # 🔧 YAML 로더 및 프롬프트 빌더
├── api_integration.py    # 🤖 Gemini API 통신 (YAML 연동)
└── app.py               # 🌐 Flask 서버 (YAML 연동)
```

## 📁 파일 구조

### 1. **prompts.yaml** - 프롬프트 설정 파일
- 모든 AI 프롬프트 템플릿 중앙 관리
- 시스템 설정, 액션 태그 정의
- 다국어 지원 가능

### 2. **prompt_manager.py** - 프롬프트 관리자
- YAML 파일 로드 및 파싱
- 동적 프롬프트 구성
- 오류 처리 및 폴백 메커니즘

### 3. **수정된 기존 파일들**
- `api_integration.py`: 하드코딩된 프롬프트 제거
- `app.py`: YAML 기반 프롬프트 사용
- `requirements.txt`: PyYAML 의존성 추가

## 🎯 YAML 설정 구조

### **기본 설정**
```yaml
system_config:
  model_temperature: 0.7      # AI 모델 창의성 수준
  max_output_tokens: 2048     # 최대 응답 길이
  response_language: "korean" # 응답 언어
```

### **액션 태그**
```yaml
action_tags:
  light_on: "[ACTION_LIGHT_ON]"
  light_off: "[ACTION_LIGHT_OFF]"
  fan_on: "[ACTION_FAN_ON]"
  fan_off: "[ACTION_FAN_OFF]"
  # ... 기타 장치 제어 태그
```

### **챗봇 프롬프트**
```yaml
chatbot_prompts:
  system_role: |
    당신은 스마트 온실 시스템의 전문가입니다.
    식물에 대해서 많은 것을 알고 사용자들에게 설명할 수 있습니다.
  
  action_guidelines: |
    1. 사용자가 장치 제어를 요청할 경우 다음 액션 태그를 반드시 포함하세요:
       - 조명 켜기: [ACTION_LIGHT_ON]
       - 조명 끄기: [ACTION_LIGHT_OFF]
       # ...
  
  examples:
    - user: "불 켜줘"
      bot: "네, 조명을 켰습니다. [ACTION_LIGHT_ON]"
    - user: "팬 꺼줘"
      bot: "네, 팬을 껐습니다. [ACTION_FAN_OFF]"
```

### **이미지 분석 프롬프트**
```yaml
image_analysis_prompts:
  system_role: |
    당신은 스마트 온실 시스템의 식물 분석 도우미입니다.
    식물 건강 상태, 질병, 영양 결핍 등을 분석하고 적절한 조치를 제안해 주세요.
  
  analysis_guidelines: |
    이미지 분석 지침:
    1. 식물의 전반적인 건강 상태를 평가하세요.
    2. 잎의 색깔, 모양, 크기를 자세히 관찰하세요.
    # ...
```

## 🔧 사용법

### **1. 기본 프롬프트 생성**
```python
from prompt_manager import get_chatbot_prompt, get_image_prompt

# 챗봇 프롬프트 생성
chatbot_prompt = get_chatbot_prompt(
    temperature=25.5,
    humidity=60.0,
    soil=45.0,
    power=120.0,
    device_status={'fan': False, 'light': True},
    user_message="불 켜줘"
)

# 이미지 분석 프롬프트 생성
image_prompt = get_image_prompt(
    user_prompt="이 식물이 건강한가요?",
    temperature=25.0,
    humidity=60.0,
    soil=50.0
)
```

### **2. 설정 조회**
```python
from prompt_manager import get_system_config, get_error_message

# 시스템 설정 조회
config = get_system_config()
temperature = config['model_temperature']  # 0.7

# 오류 메시지 조회
error_msg = get_error_message('chat_error')
```

### **3. 설정 다시 로드**
```python
from prompt_manager import reload_prompts

# 서버 재시작 없이 YAML 설정 다시 로드
reload_prompts()
```

### **4. 직접 PromptManager 사용**
```python
from prompt_manager import prompt_manager

# 액션 태그 가져오기
light_on_tag = prompt_manager.get_action_tag('light_on')  # [ACTION_LIGHT_ON]

# 기본 응답 가져오기
greeting = prompt_manager.get_default_response('greeting')
```

## 🎨 프롬프트 커스터마이징

### **1. 새로운 장치 추가**
```yaml
# prompts.yaml에 추가
action_tags:
  heater_on: "[ACTION_HEATER_ON]"
  heater_off: "[ACTION_HEATER_OFF]"

chatbot_prompts:
  examples:
    - user: "히터 켜줘"
      bot: "네, 히터를 켰습니다. [ACTION_HEATER_ON]"
```

### **2. 새로운 언어 지원**
```yaml
# 영어 프롬프트 추가
chatbot_prompts_en:
  system_role: |
    You are an expert in smart greenhouse systems.
    You can explain a lot about plants to users.
```

### **3. 컨텍스트 템플릿 수정**
```yaml
context_templates:
  greenhouse_status: |
    Smart Greenhouse Status:
    - Temperature: {temperature}°C
    - Humidity: {humidity}%
    - Soil Moisture: {soil}%
    - Power Usage: {power}W
```

## 🚀 고급 기능

### **1. 동적 프롬프트 구성**
```python
# 런타임에 프롬프트 구성 변경
prompt_manager.config['chatbot_prompts']['system_role'] = "새로운 역할 정의"

# 특정 조건에 따른 프롬프트 변경
if user_level == 'expert':
    prompt = get_expert_chatbot_prompt(...)
else:
    prompt = get_basic_chatbot_prompt(...)
```

### **2. A/B 테스트 지원**
```yaml
# 다양한 프롬프트 버전 정의
chatbot_prompts_v1:
  system_role: "기본 버전 프롬프트"

chatbot_prompts_v2:
  system_role: "개선된 버전 프롬프트"
```

### **3. 조건부 프롬프트**
```python
def get_conditional_prompt(user_type, season, time_of_day):
    base_prompt = prompt_manager.get_basic_system_prompt()
    
    if season == 'winter':
        base_prompt += "\n겨울철 온실 관리에 특히 주의해주세요."
    
    if time_of_day == 'night':
        base_prompt += "\n야간 모드를 고려한 조명 관리를 제안해주세요."
    
    return base_prompt
```

## 🛠️ 개발 가이드

### **1. 새로운 프롬프트 타입 추가**
```python
# prompt_manager.py에 새 메서드 추가
def get_weather_prompt(self, location, conditions):
    weather_prompts = self.config.get('weather_prompts', {})
    template = weather_prompts.get('forecast_template', '')
    return template.format(location=location, conditions=conditions)
```

### **2. 검증 시스템 추가**
```python
def validate_prompt_config(self):
    """YAML 설정 유효성 검사"""
    required_keys = ['system_config', 'chatbot_prompts', 'action_tags']
    for key in required_keys:
        if key not in self.config:
            raise ValueError(f"필수 설정 키 누락: {key}")
```

### **3. 캐싱 시스템**
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_cached_prompt(prompt_type, **kwargs):
    """자주 사용되는 프롬프트 캐싱"""
    if prompt_type == 'chatbot':
        return get_chatbot_prompt(**kwargs)
    elif prompt_type == 'image':
        return get_image_prompt(**kwargs)
```

## 📊 성능 최적화

### **1. 프롬프트 길이 최적화**
```yaml
# 간결한 버전과 상세한 버전 분리
chatbot_prompts:
  brief_guidelines: "간단한 지침들..."
  detailed_guidelines: "상세한 지침들..."

prompt_composition:
  quick_mode: ["system_role", "brief_guidelines"]
  full_mode: ["system_role", "detailed_guidelines", "examples"]
```

### **2. 지연 로딩**
```python
class LazyPromptManager:
    def __init__(self):
        self._config = None
    
    @property
    def config(self):
        if self._config is None:
            self._config = self._load_config()
        return self._config
```

## 🔍 디버깅 및 모니터링

### **1. 프롬프트 로깅**
```python
import logging

# 프롬프트 사용 로그
logging.info(f"프롬프트 생성: 타입={prompt_type}, 길이={len(prompt)}")
```

### **2. 프롬프트 버전 관리**
```yaml
meta:
  version: "1.2.0"
  last_updated: "2024-01-15"
  author: "AI Team"
  changelog:
    - "v1.2.0: 이미지 분석 프롬프트 개선"
    - "v1.1.0: 새로운 액션 태그 추가"
```

## 🎯 사용 예시

### **시나리오 1: 새로운 센서 추가**
```yaml
# 1. prompts.yaml에 새 센서 추가
context_templates:
  greenhouse_status: |
    스마트 온실 시스템 정보:
    - 온도: {temperature}°C
    - 습도: {humidity}%
    - 토양 습도: {soil}%
    - 전력 사용량: {power}W
    - CO2 농도: {co2}ppm  # 새로 추가
```

```python
# 2. 코드에서 새 센서 데이터 사용
prompt = get_chatbot_prompt(
    temperature=25.0,
    humidity=60.0,
    soil=45.0,
    power=120.0,
    co2=400,  # 새 센서 데이터
    user_message="CO2 농도가 어때?"
)
```

### **시나리오 2: 다국어 지원**
```yaml
# 한국어 설정
chatbot_prompts_ko:
  greeting: "안녕하세요! 스마트 온실 관리를 도와드릴게요."

# 영어 설정  
chatbot_prompts_en:
  greeting: "Hello! I'll help you manage your smart greenhouse."
```

```python
# 언어별 프롬프트 선택
def get_localized_prompt(language='ko', **kwargs):
    if language == 'en':
        return get_english_chatbot_prompt(**kwargs)
    else:
        return get_chatbot_prompt(**kwargs)
```

## 🔧 유지보수

### **정기 작업**
1. **프롬프트 성능 분석**: AI 응답 품질 모니터링
2. **설정 백업**: `prompts.yaml` 정기 백업
3. **버전 관리**: Git을 통한 프롬프트 변경사항 추적
4. **A/B 테스트**: 새로운 프롬프트 버전 테스트

### **문제 해결**
```bash
# 설정 파일 유효성 검사
python3 -c "import yaml; yaml.safe_load(open('prompts.yaml'))"

# 프롬프트 매니저 테스트
python3 prompt_manager.py

# 백엔드 서버 재시작
python3 app.py
```

이제 MyApp의 프롬프트 엔지니어링이 **완전히 YAML 기반으로 중앙 관리**됩니다!

## ✨ 주요 장점

1. **코드 수정 없이 프롬프트 변경** 🔄
2. **중앙 집중식 관리** 📁  
3. **버전 관리 및 백업** 💾
4. **다국어 지원 가능** 🌍
5. **A/B 테스트 용이** 🧪
6. **전문적이고 간결한 톤** 💼 