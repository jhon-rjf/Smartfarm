# 🌿 MyApp - 스마트 온실 시스템 프로젝트 구조 분석

## 📋 프로젝트 개요

**프로젝트명**: Smart Greenhouse System (MyApp)  
**타입**: React Native (Expo) + Python Flask 백엔드  
**목적**: IoT 기반 스마트 온실 관리 시스템  
**플랫폼**: iOS, Android, Web 호환  

## 🏗️ 전체 아키텍처

```
MyApp/
├── Frontend (React Native/Expo)
│   ├── App.js (메인 네비게이션)
│   ├── screens/ (화면 컴포넌트)
│   ├── components/ (재사용 컴포넌트)
│   ├── services/ (API 통신)
│   └── assets/ (이미지, 아이콘)
├── Backend (Python Flask)
│   ├── app.py (메인 서버)
│   ├── weather_api.py (날씨 API)
│   ├── sensors.py (센서 제어)
│   ├── influx_storage.py (데이터 저장)
│   └── api_integration.py (API 통합)
└── Database (InfluxDB)
    └── 시계열 센서 데이터 저장
```

## 📱 프론트엔드 구조 (React Native/Expo)

### 🗂️ 폴더 구조

```
MyApp/
├── App.js                 # 메인 앱 컴포넌트 (네비게이션)
├── index.js               # 앱 엔트리 포인트
├── app.json               # Expo 앱 설정
├── package.json           # 의존성 관리
├── screens/
│   └── ChatbotScreen.js   # 챗봇 화면 (634줄)
├── components/
│   ├── StatusCards.js     # 센서 상태 카드
│   ├── DeviceControl.js   # 장치 제어 패널
│   ├── GraphBox.js        # 데이터 그래프
│   └── Chatbot.js         # 챗봇 컴포넌트
├── services/
│   └── api.js             # API 통신 서비스 (452줄)
└── assets/
    ├── greenhouse.png     # 배경 이미지 (4MB)
    ├── chatbot.png        # 챗봇 아이콘 (1.4MB)
    ├── icon.png           # 앱 아이콘
    └── splash-icon.png    # 스플래시 화면
```

### 🎯 핵심 기능

#### 1. **메인 화면 (HomeScreen)**
- **센서 데이터 실시간 모니터링**
  - 온도 (°C)
  - 습도 (%)
  - 전력 사용량 (W)
  - 토양 습도 (%)
- **장치 제어 패널**
  - 환풍기 (Fan) On/Off
  - 급수 시스템 (Water) On/Off
  - 조명 (Light) On/Off
  - 창문 (Window) Open/Close
- **실시간 그래프 표시**
  - 선택된 센서 데이터의 시계열 그래프
  - 5개 데이터 포인트 표시

#### 2. **챗봇 화면 (ChatbotScreen)**
- **Gemini AI 기반 대화형 인터페이스**
- **음성 명령 제어** (자연어 처리)
  - "불 켜줘" → 조명 켜기
  - "팬 켜줘" → 환풍기 켜기
  - "물 줘" → 급수 시작
  - "창문 열어줘" → 창문 열기
- **이미지 분석 기능**
  - 식물 사진 업로드
  - AI 기반 식물 상태 진단
  - 개선 방안 제안
- **위치 기반 날씨 정보 제공**

#### 3. **네비게이션 구조**
```javascript
NavigationContainer
├── Tab Navigator
│   ├── Home (홈 화면)
│   │   └── Stack Navigator
│   │       ├── HomeScreen
│   │       └── ChatScreen
│   └── Chatbot (챗봇 화면)
└── Floating Chat Button (플로팅 버튼)
```

#### 4. **권한 및 기능**
- **위치 정보**: 사용자 위치 기반 날씨 데이터
- **카메라**: 식물 상태 촬영 및 분석
- **갤러리**: 기존 식물 이미지 선택
- **네트워크**: 실시간 IoT 데이터 통신

## 🖥️ 백엔드 구조 (Python Flask)

### 🗂️ 폴더 구조

```
backend/
├── app.py                 # 메인 Flask 서버 (399줄)
├── weather_api.py         # 날씨 API 서비스 (669줄)
├── sensors.py             # 센서 하드웨어 제어 (144줄)
├── influx_storage.py      # InfluxDB 데이터 관리 (184줄)
├── api_integration.py     # 외부 API 통합 (179줄)
├── requirements.txt       # Python 의존성
├── README.md             # 백엔드 문서
└── 테스트 파일들
    ├── test_api.py
    ├── test_weather.py
    └── debug_weather.py
```

### 🔧 의존성 (requirements.txt)
```python
flask==2.3.3           # 웹 프레임워크
flask-cors==4.0.0      # CORS 처리
requests==2.31.0       # HTTP 요청
python-dotenv==1.0.0   # 환경변수 관리
pillow==10.0.0         # 이미지 처리
numpy==1.25.2          # 수치 계산
influxdb-client==1.36.1 # 시계열 데이터베이스
urllib3==2.0.7         # HTTP 클라이언트
certifi==2024.2.2      # SSL 인증서
```

### 🛠️ API 엔드포인트

#### 1. **센서 데이터 API**
```python
GET /api/status
# 응답 예시
{
  "temperature": 23.5,
  "humidity": 58.0,
  "power": 135.0,
  "soil": 42.0,
  "devices": {
    "fan": false,
    "water": false,
    "light": false,
    "window": false
  },
  "timestamp": "2023-05-15T08:30:45.123Z"
}
```

#### 2. **장치 제어 API**
```python
POST /api/control
# 요청 본문
{
  "device": "fan",    # fan, water, light, window
  "status": true      # true(켜기), false(끄기)
}
```

#### 3. **히스토리 데이터 API**
```python
GET /api/history?metric=temperature
# metric: temperature, humidity, power, soil
```

#### 4. **챗봇 API**
```python
POST /api/chat
# 요청 본문
{
  "message": "온실에 적합한 온도는 얼마인가요?",
  "sessionId": "unique_session_id",
  "location": "서울"
}
```

#### 5. **이미지 분석 API**
```python
POST /api/analyze-image
# 멀티파트 폼 데이터
# - image: 이미지 파일
# - prompt: 분석 요청 텍스트
```

#### 6. **날씨 API**
```python
GET /api/weather?region=서울
GET /api/current-weather?region=서울
```

### 🔌 하드웨어 인터페이스

#### **센서 연결 방식**
| 센서 타입 | 모델명 | 연결 핀 | 데이터 형식 | 측정 범위 | 정확도 |
|-----------|--------|---------|------------|-----------|--------|
| 온도 센서 | DHT22 | GPIO 4 | 디지털 | -40~80°C | ±0.5°C |
| 습도 센서 | DHT22 | GPIO 4 | 디지털 | 0~100% | ±2% |
| 토양 습도 | 저항형 | ADC 채널 0 | 아날로그 | 0~100% | ±5% |
| 전력 측정 | ACS712 | ADC 채널 1 | 아날로그 | 0~500W | ±1% |

#### **장치 제어 방식**
| 장치 ID | 제어 방식 | 연결 핀 | 제어 신호 타입 |
|---------|-----------|---------|---------------|
| fan | GPIO | GPIO 18 | 디지털 (0/1) |
| water | PWM 펌프 | GPIO 12 | PWM (0~255) |
| light | 릴레이 모듈 | GPIO 23 | 디지털 (0/1) |
| window | 서보 모터 | GPIO 25 | PWM (0~180) |

## 🤖 AI 기능

### 1. **Gemini AI 챗봇**
- **자연어 처리**: 사용자 명령 이해
- **장치 제어**: 음성/텍스트로 IoT 기기 제어
- **농업 전문 지식**: 온실 관리 조언 제공
- **세션 관리**: 대화 컨텍스트 유지

### 2. **이미지 분석**
- **식물 상태 진단**: 잎 색깔, 모양 분석
- **병해충 탐지**: 질병 및 해충 식별
- **성장 상태 평가**: 건강도 점수 제공
- **개선 방안 제안**: 맞춤형 관리 조언

### 3. **액션 태그 시스템**
| 액션 태그 | 설명 | 실행 명령 |
|-----------|------|-----------|
| [ACTION_FAN_ON] | 환풍기 켜기 | controlDevice('fan', true) |
| [ACTION_FAN_OFF] | 환풍기 끄기 | controlDevice('fan', false) |
| [ACTION_WATER_ON] | 급수 시작 | controlDevice('water', true) |
| [ACTION_WATER_OFF] | 급수 중단 | controlDevice('water', false) |
| [ACTION_LIGHT_ON] | 조명 켜기 | controlDevice('light', true) |
| [ACTION_LIGHT_OFF] | 조명 끄기 | controlDevice('light', false) |
| [ACTION_WINDOW_OPEN] | 창문 열기 | controlDevice('window', true) |
| [ACTION_WINDOW_CLOSE] | 창문 닫기 | controlDevice('window', false) |

## 📊 데이터 관리

### 1. **InfluxDB 시계열 데이터베이스**
- **센서 데이터 저장**: 온도, 습도, 전력, 토양 습도
- **실시간 수집**: 5초 간격 데이터 수집
- **히스토리 제공**: 시계열 그래프용 데이터
- **효율적 압축**: 장기간 데이터 보관

### 2. **데이터 폴링 주기**
- **센서 데이터 갱신**: 5초
- **클라이언트 앱 요청**: 30초
- **실시간 업데이트**: WebSocket 또는 폴링

## 🌐 네트워크 구성

### 1. **서버 정보**
- **메인 서버**: `http://gknu-comeng.kro.kr:5001`
- **프로토콜**: HTTP/HTTPS
- **CORS 설정**: 모든 도메인 허용

### 2. **API 보안**
- **Gemini API 키**: 환경변수로 관리
- **요청 제한**: 동시 요청 5개 제한
- **타임아웃 처리**: 5초 타임아웃
- **재시도 로직**: 실패 시 최대 3회 재시도

## 🔧 개발 환경 설정

### **프론트엔드 실행**
```bash
# 의존성 설치
npm install

# Expo 개발 서버 시작
npx expo start

# 특정 플랫폼 실행
npx expo start --ios
npx expo start --android
npx expo start --web
```

### **백엔드 실행**
```bash
# 가상환경 생성
python -m venv MYAPP_ENV
source MYAPP_ENV/bin/activate  # Linux/Mac
# MYAPP_ENV\Scripts\activate   # Windows

# 의존성 설치
pip install -r requirements.txt

# 환경변수 설정 (.env 파일)
GEMINI_API_KEY=your_gemini_api_key_here

# 서버 시작
python app.py
```

## 🎨 UI/UX 특징

### 1. **디자인 시스템**
- **배경 이미지**: 온실 테마
- **반투명 카드**: 가독성과 미관 균형
- **아이콘 시스템**: 직관적인 이모지 사용
- **반응형 레이아웃**: 다양한 화면 크기 지원

### 2. **사용자 경험**
- **플로팅 챗봇 버튼**: 언제든 접근 가능
- **실시간 피드백**: 장치 제어 즉시 반영
- **오프라인 대응**: 네트워크 오류 시 더미 데이터
- **로딩 상태**: 사용자에게 진행 상황 표시

## 🧪 테스트 구조

### **백엔드 테스트**
- `test_api.py`: API 엔드포인트 테스트
- `test_weather.py`: 날씨 API 테스트
- `debug_weather.py`: 날씨 API 디버깅

### **테스트 실행**
```bash
# API 테스트
python test_api.py

# 날씨 API 테스트
python test_weather.py

# 디버그 모드
python debug_weather.py
```

## 📈 확장 가능성

### 1. **새로운 센서 추가**
1. 백엔드 센서 연결 코드 추가
2. API 응답 포맷 업데이트
3. 프론트엔드 UI 컴포넌트 추가
4. 데이터베이스 스키마 확장

### 2. **새로운 제어 장치 추가**
1. 하드웨어 인터페이스 구현
2. 장치 상태 관리 로직 추가
3. 챗봇 명령어 패턴 확장
4. UI 제어 패널 업데이트

### 3. **고급 기능 확장**
- **머신러닝 모델**: 예측적 온실 관리
- **알림 시스템**: 임계값 기반 알림
- **원격 모니터링**: 다중 온실 관리
- **데이터 분석**: 성장 패턴 분석
- **자동화 시나리오**: 조건부 장치 제어

## 🚨 문제 해결 가이드

### 1. **일반적인 문제**
- **네트워크 연결 오류**: 서버 상태 확인
- **센서 데이터 누락**: 하드웨어 연결 점검
- **챗봇 응답 지연**: API 키 및 네트워크 확인
- **이미지 분석 실패**: 이미지 크기 및 형식 확인

### 2. **로그 확인**
- **서버 로그**: `/var/log/greenhouse-system.log`
- **클라이언트 로그**: 브라우저 개발자 도구
- **디버그 모드**: 개발 환경에서 상세 로그 활성화

### 3. **성능 최적화**
- **API 호출 최적화**: 중복 요청 방지
- **이미지 크기 최적화**: 1024x1024 리사이징
- **데이터 캐싱**: 자주 사용되는 데이터 캐시
- **메모리 관리**: 불필요한 구독 해제

## 📝 개발 우선순위

### **Phase 1: 핵심 기능 완성**
- [x] 센서 데이터 실시간 모니터링
- [x] 장치 제어 인터페이스
- [x] 기본 챗봇 기능
- [x] 이미지 분석 기능

### **Phase 2: 사용자 경험 개선**
- [ ] 알림 시스템 구현
- [ ] 데이터 시각화 고도화
- [ ] 오프라인 모드 지원
- [ ] 사용자 설정 저장

### **Phase 3: 고급 기능 추가**
- [ ] 머신러닝 기반 예측
- [ ] 다중 온실 지원
- [ ] 원격 모니터링
- [ ] 자동화 시나리오

## 🎯 프로젝트 목표

이 스마트 온실 시스템은 **IoT 센서**, **AI 기술**, **모바일 앱**을 통합하여 효율적이고 지능적인 온실 관리 솔루션을 제공합니다. 사용자는 직관적인 인터페이스와 자연어 명령을 통해 온실을 손쉽게 제어하고 모니터링할 수 있으며, AI 기반 분석을 통해 최적의 작물 재배 환경을 유지할 수 있습니다. 